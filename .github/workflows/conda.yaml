# Verify that installation from conda-forge works as intended

name: Install from conda-forge

on:
  # 05:00 UTC = 06:00 CET = 07:00 CEST
  schedule:
  - cron: "0 5 * * *"
  # Uncomment to debug
  pull_request:
   branches: [ main ]

env:
  # Name of the test environment to create
  CONDA_ENV: testenv

jobs:
  conda:
    strategy:
      matrix:
#        os: [windows-latest, macos-latest]
        os: [macos-latest]
#        conda: [anaconda, miniconda]
        conda: [miniconda]
        extra_deps:
          - ""
#          - "JPype1=1.2.1"
      fail-fast: false

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }}-${{ matrix.conda }}-${{ matrix.extra_deps }}

    steps:
#    - name: Cache Anaconda installer, conda packages
#      uses: actions/cache@v2
#      with:
#        path: |
#          $CONDA/pkgs
#          ~/.conda/pkgs
#          ~/anaconda3/pkgs
#          ~/appdata/local/conda/conda/pkgs
#          ${{ github.workspace }}/Anaconda*.exe
#        key: ${{ matrix.os }}-${{ matrix.conda }}

    - name: Setup anaconda
      if: ${{ matrix.conda == 'anaconda' }}
      uses: iiasa/actions/setup-conda@main
      with:
        installer: ${{ matrix.conda }}
        version: 2019.03

    - name: Setup miniconda
      if: ${{ matrix.conda == 'miniconda' }}
      uses: iiasa/actions/setup-conda@main
      with:
        installer: ${{ matrix.conda }}
        version: py39_4.10.3

    - name: Check conda version and location
      run: conda info

    - name: Configure Shell for "conda activate" macos-latest
      if: ${{ matrix.os == 'macos-latest' }}
      run: |
        conda init bash

    - name: Configure PowerShell for "conda activate" windows-latest
      if: ${{ matrix.os == 'windows-latest' }}
      run: conda init powershell

    - name: Install message-ix on macos
      if: ${{ matrix.os == 'macos-latest' }}
      run: |
        conda config --prepend channels conda-forge
        conda create --name ${{ env.CONDA_ENV }} --quiet message-ix pytest ${{ matrix.extra_deps }}

    - name: Install message-ix on windows
      if: ${{ matrix.os == 'windows-latest' }}
      run: |
        conda config --prepend channels conda-forge
        conda create --name ${{ env.CONDA_ENV }} --quiet message-ix pytest ${{ matrix.extra_deps }}

    - name: Check
      # Check environment and run a single test from the suite to test code path to ixmp JDBCBackend
      run: |
        source /Users/runner/work/_actions/iiasa/actions/main/setup-conda/${{ matrix.conda }}3/etc/profile.d/conda.sh
        conda activate ${{ env.CONDA_ENV }}

        conda info

        message-ix show-versions
        ixmp --platform default list

        conda list
        pytest --pyargs message_ix.tests.test_core::test_add_cat --rootdir=D:\a\_actions\iiasa\actions\main\setup-conda\${{ matrix.conda }}3\envs\testenv\lib\site-packages -p ixmp.testing -p no:faulthandler
