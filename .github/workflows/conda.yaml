# Verify that installation from conda-forge works as intended

name: Install from conda-forge

on:
  # 05:00 UTC = 06:00 CET = 07:00 CEST
  schedule:
  - cron: "0 5 * * *"
  # Uncomment to debug
  pull_request:
   branches: [ main ]

env:
  # Name of the test environment to create
  CONDA_ENV: testenv

jobs:
  conda:
    strategy:
      matrix:
        # os: [windows-latest, macos-latest]
        os: [windows-latest]
        conda: [anaconda, miniconda]
        extra_deps:
          - ""
          - "JPype1=1.2.1"
      fail-fast: false

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }}-${{ matrix.conda }}

    steps:
    - name: Cache Anaconda installer, conda packages
      uses: actions/cache@v2
      with:
        path: |
          $CONDA/pkgs
          ~/.conda/pkgs
          ~/anaconda3/pkgs
          ~/appdata/local/conda/conda/pkgs
          ${{ github.workspace }}/Anaconda*.exe
        key: ${{ matrix.os }}-${{ matrix.conda }}

    - name: Setup anaconda
      if: ${{ matrix.conda == 'anaconda' }}
      uses: iiasa/actions/setup-conda@main
      with:
        installer: ${{ matrix.conda }}
        version: 2021.11

    - name: Setup miniconda
      if: ${{ matrix.conda == 'miniconda' }}
      uses: iiasa/actions/setup-conda@main
      with:
        installer: ${{ matrix.conda }}
        version: py39_4.10.3

    - name: Check conda version and location
      run: conda info

#    - name: Configure Shell for "conda activate"
#      if: |
#        ${{ matrix.os == 'macos-latest' }} ||
#        ${{ matrix.conda == 'miniconda' }}
#      run: |
#        conda init bash
#        source ~/Miniconda3/etc/profile.d/conda.sh
#
#
#    - name: Configure Shell for "conda activate"
#      if: |
#        ${{ matrix.os == 'macos-latest' }} ||
#        ${{ matrix.conda == 'anaconda' }}
#      run: |
#        conda init bash
#        source ~/Anaconda3/etc/profile.d/conda.csh

    - name: Configure PowerShell for "conda activate"
      if: ${{ matrix.os == 'windows-latest' }}
      run: conda init powershell
#
#    - name: Install message-ix
#      if: ${{ matrix.os == 'macos-latest' }}
#      run: |
#        conda config --prepend channels conda-forge
#        conda config --set channel_priority strict
#        conda create --name ${{ env.CONDA_ENV }} --quiet message-ix pytest ${{ matrix.extra_deps }}

    - name: Install message-ix
      if: ${{ matrix.os == 'windows-latest' }}
      run: |
        conda config --prepend channels conda-forge
        conda create --name ${{ env.CONDA_ENV }} --quiet message-ix pytest ${{ matrix.extra_deps }}

    - name: Check
      # Check environment and run a single test from the suite to test code path to ixmp JDBCBackend
      run: |
        conda activate ${{ env.CONDA_ENV }}

        conda info

        message-ix show-versions
        ixmp --platform default list

        conda list
        pytest --pyargs message_ix.tests.test_core::test_add_cat -p ixmp.testing -p no:faulthandler
